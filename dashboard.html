<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ•°æ®çœ‹æ¿ - Weatheraintbad</title>
    <link rel="stylesheet" href="styles.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Noto+Serif+SC:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        /* ä»ªè¡¨æ¿ç‰¹å®šæ ·å¼ */
        .dashboard {
            min-height: 100vh;
            background: linear-gradient(135deg, var(--bg-primary) 0%, var(--bg-secondary) 100%);
            position: relative;
            overflow: hidden;
        }

        .dashboard::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: radial-gradient(circle at 50% 50%, rgba(250, 167, 85, 0.05) 0%, transparent 70%);
            z-index: 0;
        }

        .dashboard-content {
            position: relative;
            z-index: 1;
            padding: 120px 0 60px;
        }

        /* æ€»è§ˆå¡ç‰‡ */
        .overview {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: var(--bg-card);
            border-radius: 16px;
            padding: 30px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            text-align: center;
            transition: transform 0.3s;
        }

        .stat-card:hover { transform: translateY(-5px); }

        .stat-card.modrinth { border-top: 5px solid #00d47e; }
        .stat-card.curseforge { border-top: 5px solid #f16436; }
        .stat-card.total { border-top: 5px solid #ffd700; background: linear-gradient(135deg, var(--bg-card) 0%, rgba(255, 250, 240, 0.8) 100%); }

        .platform-icon {
            width: 40px;
            height: 40px;
            margin-bottom: 10px;
            font-size: 2em;
        }

        .stat-label {
            font-size: 0.9em;
            color: var(--secondary-color);
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 5px;
        }

        .stat-value {
            font-size: 2.5em;
            font-weight: bold;
            color: var(--accent-color);
            margin: 10px 0;
        }

        /* åŠ è½½å’Œé”™è¯¯çŠ¶æ€ï¼ˆä¿ç•™åŸºç¡€æ ·å¼ï¼‰ */
        .loading {
            text-align: center;
            padding: 40px;
            color: var(--secondary-color);
        }

        .error {
            background: #fed7d7;
            color: #c53030;
            padding: 12px 20px;
            border-radius: 8px;
            margin: 10px 0;
            border-left: 4px solid #c53030;
        }

        /* æ—¥æœŸæ—¶é—´å¤©æ°”åŒºåŸŸ */
        .dashboard-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 2rem;
            margin-bottom: 3rem;
        }

        .dashboard-card {
            background-color: var(--bg-card);
            padding: 2rem;
            border-radius: 15px;
            border: 1px solid var(--border-color);
            transition: var(--transition);
            text-align: center;
        }

        .dashboard-card:hover {
            border-color: var(--accent-color);
            transform: translateY(-5px);
            box-shadow: 0 10px 30px rgba(255, 140, 0, 0.1);
        }

        .card-title {
            font-size: 1.2rem;
            font-weight: 600;
            margin-bottom: 1rem;
            color: var(--secondary-color);
        }

        .card-content {
            font-size: 2.5rem;
            font-weight: 700;
            color: var(--accent-color);
            margin-bottom: 0.5rem;
        }

        .card-subtitle {
            font-size: 0.9rem;
            color: var(--secondary-color);
        }

        .datetime-card {
            grid-column: span 2;
        }

        .datetime-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
        }

        .date-section, .time-section {
            flex: 1;
            min-width: 200px;
        }

        .weather-card {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 1rem;
        }

        .weather-icon {
            font-size: 3rem;
        }

        .weather-info {
            text-align: left;
        }

        /* å“åº”å¼è®¾è®¡ */
        @media (max-width: 768px) {
            .dashboard-grid {
                grid-template-columns: 1fr;
            }

            .datetime-card {
                grid-column: span 1;
            }

            .datetime-content {
                flex-direction: column;
                gap: 1rem;
            }
        }
    </style>
</head>
<body>
    <!-- å¯¼èˆªæ  -->
    <nav class="navbar">
        <div class="nav-container">
            <div class="logo">
                <a href="index.html" style="text-decoration: none; color: inherit;">Weatheraintbad.com</a>
            </div>
            <ul class="nav-menu">
                <li><a href="dashboard.html" style="color: var(--accent-color);">æ•°æ®çœ‹æ¿</a></li>
            </ul>
            <button id="theme-toggle" class="theme-toggle" aria-label="åˆ‡æ¢ä¸»é¢˜">
                <svg class="sun-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <circle cx="12" cy="12" r="5"></circle>
                    <line x1="12" y1="1" x2="12" y2="3"></line>
                    <line x1="12" y1="21" x2="12" y2="23"></line>
                    <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
                    <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
                    <line x1="1" y1="12" x2="3" y2="12"></line>
                    <line x1="21" y1="12" x2="23" y2="12"></line>
                    <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
                    <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
                </svg>
                <svg class="moon-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
                </svg>
            </button>
        </div>
    </nav>

    <!-- ä»ªè¡¨æ¿å†…å®¹ -->
    <section class="dashboard">
        <div class="dashboard-content">
            <div class="container">
                <h1 class="dashboard-title">æ•°æ®çœ‹æ¿</h1>

                <!-- æ—¥æœŸæ—¶é—´å¤©æ°”åŒºåŸŸ -->
                <div class="dashboard-grid">
                    <div class="dashboard-card datetime-card">
                        <div class="datetime-content">
                            <div class="date-section">
                                <div class="card-title">å½“å‰æ—¥æœŸ</div>
                                <div class="card-content" id="current-date">åŠ è½½ä¸­...</div>
                                <div class="card-subtitle" id="current-week">æ˜ŸæœŸ</div>
                            </div>
                            <div class="time-section">
                                <div class="card-title">å½“å‰æ—¶é—´</div>
                                <div class="card-content" id="current-time">00:00:00</div>
                                <div class="card-subtitle" id="current-period">ä¸Šåˆ</div>
                            </div>
                        </div>
                    </div>

                    <div class="dashboard-card weather-card">
                        <div class="weather-icon">â˜€ï¸</div>
                        <div class="weather-info">
                            <div class="card-title">ä½›å±±å¤©æ°”</div>
                            <div class="card-content" id="weather-temp">25Â°C</div>
                            <div class="card-subtitle" id="weather-desc">æ™´æœ—</div>
                        </div>
                    </div>
                </div>

                <!-- æ¨¡ç»„ä¸‹è½½ç»Ÿè®¡ -->
                <h2 style="text-align: center; margin-bottom: 2rem; color: var(--primary-color);">ğŸ® æ¨¡ç»„ä¸‹è½½é‡ç»Ÿè®¡</h2>

                <!-- æ€»è§ˆåŒºåŸŸ -->
                <div class="overview" id="overview">
                    <div class="stat-card modrinth">
                        <div class="platform-icon">ğŸŸ¢</div>
                        <div class="stat-label">Modrinth ä¸‹è½½é‡</div>
                        <div class="stat-value" id="modrinth-total">-</div>
                    </div>

                    <div class="stat-card curseforge">
                        <div class="platform-icon">ğŸŸ </div>
                        <div class="stat-label">CurseForge ä¸‹è½½é‡</div>
                        <div class="stat-value" id="curseforge-total">-</div>
                    </div>

                    <div class="stat-card total">
                        <div class="platform-icon">ğŸ†</div>
                        <div class="stat-label">æ€»ä¸‹è½½é‡</div>
                        <div class="stat-value" id="grand-total">-</div>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <script src="script.js"></script>
    <script>
        // --- é…ç½®åŒºåŸŸ START ---

        // åœ¨æ­¤é…ç½®æ‚¨çš„é¡¹ç›®åˆ—è¡¨
        const MOD_CONFIG = {
            modrinth: [
                 { id: 'hvnOGUOZ', name: 'Stardew HUD' },
                 { id: '1QJ8nLvE', name: 'Every Single Day' },
                 { id: 'gI6SaK3q', name: 'Lucky Fishing Rod' },
                 { id: 'GFtuSNC2', name: 'Totem of Luck' },
                 { id: '33haE7q6', name: 'Yos Coins' },
                 { id: 'qOekRw8e', name: 'Yos Trade Post' },
            ],

            curseforge: [
                 { id: 1418842, name: 'Stardew HUD' },
                 { id: 1418852, name: 'Every Single Day' },
                 { id: 1418181, name: 'Lucky Fishing Rod' },
                 { id: 1418161, name: 'Totem of Luck' },
                 { id: 1418846, name: 'Yos Coins' },
                 { id: 1421959, name: 'Yos Trade Post' },
            ]
        };

        // æ˜¯å¦å¯ç”¨è°ƒè¯•æ¨¡å¼ï¼ˆæ§åˆ¶å°è¾“å‡ºè¯¦ç»†ä¿¡æ¯ï¼‰
        const DEBUG_MODE = true;

        // --- é…ç½®åŒºåŸŸ END ---

        // API å‡½æ•°
        async function fetchDownloadCount(platform, id) {
            try {
                const params = new URLSearchParams();

                if (platform === 'modrinth') params.append('modrinth', id);
                if (platform === 'curseforge') params.append('curseforge', id);

                // ä½¿ç”¨ CORS ä»£ç†æ¥è§£å†³è·¨åŸŸé—®é¢˜
                const apiUrl = `https://connorcode.com/api/downloads?${params}`;
                const proxyUrl = `https://api.allorigins.win/raw?url=${encodeURIComponent(apiUrl)}`;

                console.log(`Fetching from: ${apiUrl} via proxy: ${proxyUrl}`);

                const response = await fetch(proxyUrl);

                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}`);
                }

                const data = await response.json();
                console.log(`API Response for ${platform}#${id}:`, data);

                return {
                    raw: (platform === 'modrinth') ? data.modrinth || 0 : data.curseforge || 0,
                    human: data['total-human'] || '0'
                };
            } catch (error) {
                console.error(`Failed to fetch ${platform}#${id}:`, error);
                return { raw: 0, human: '0' };
            }
        }

        // æ•°å­—æ ¼å¼åŒ– - æ˜¾ç¤ºç²¾ç¡®æ•°å­—
        function formatNumber(num) {
            if (typeof num === 'string') {
                return num;
            }
            return num.toLocaleString(); // åªæ·»åŠ åƒä½åˆ†éš”ç¬¦ï¼Œä¸è¿›è¡Œå•ä½è½¬æ¢
        }


        // æ›´æ–°ç»Ÿè®¡æ•°æ®
        async function updateStats() {
            // ç»Ÿè®¡å˜é‡
            let mrTotal = 0;
            let cfTotal = 0;

            // å¤„ç† Modrinth
            if (MOD_CONFIG.modrinth.length > 0) {
                for (const mod of MOD_CONFIG.modrinth) {
                    try {
                        const apiUrl = `https://connorcode.com/api/downloads?modrinth=${mod.id}`;
                        console.log(`Fetching Modrinth#${mod.id} from: ${apiUrl}`);

                        // ä½¿ç”¨åŸæ¥çš„ä»£ç†
                        const proxyUrl = `https://api.allorigins.win/raw?url=${encodeURIComponent(apiUrl)}`;
                        const response = await fetch(proxyUrl);

                        if (response.ok) {
                            const data = await response.json();
                            console.log(`Modrinth#${mod.id} response:`, data);
                            mrTotal += data.modrinth || 0;
                        } else {
                            console.error(`Modrinth#${mod.id} response not OK:`, response.status);
                        }
                    } catch (error) {
                        console.error(`Failed to fetch Modrinth#${mod.id}:`, error);
                        // å¦‚æœè¯·æ±‚å¤±è´¥ï¼Œè®¾ç½®ä¸€ä¸ªé»˜è®¤å€¼æˆ–è·³è¿‡è¯¥é¡¹ç›®
                    }
                }
            }

            // å¤„ç† CurseForge
            if (MOD_CONFIG.curseforge.length > 0) {
                for (const mod of MOD_CONFIG.curseforge) {
                    try {
                        const apiUrl = `https://connorcode.com/api/downloads?curseforge=${mod.id}`;
                        console.log(`Fetching CurseForge#${mod.id} from: ${apiUrl}`);

                        // ä½¿ç”¨åŸæ¥çš„ä»£ç†
                        const proxyUrl = `https://api.allorigins.win/raw?url=${encodeURIComponent(apiUrl)}`;
                        const response = await fetch(proxyUrl);

                        if (response.ok) {
                            const data = await response.json();
                            console.log(`CurseForge#${mod.id} response:`, data);
                            cfTotal += data.curseforge || 0;
                        } else {
                            console.error(`CurseForge#${mod.id} response not OK:`, response.status);
                        }
                    } catch (error) {
                        console.error(`Failed to fetch CurseForge#${mod.id}:`, error);
                        // å¦‚æœè¯·æ±‚å¤±è´¥ï¼Œè®¾ç½®ä¸€ä¸ªé»˜è®¤å€¼æˆ–è·³è¿‡è¯¥é¡¹ç›®
                    }
                }
            }

            // è®¡ç®—æ€»ä¸‹è½½é‡ï¼ˆä½¿ç”¨æœ¬åœ°è®¡ç®—è€Œé APIï¼‰
            const total = mrTotal + cfTotal;
            const totalHuman = formatNumber(total);

            console.log('Final counts:', { mrTotal, cfTotal, total });
            document.getElementById('modrinth-total').textContent = formatNumber(mrTotal);
            document.getElementById('curseforge-total').textContent = formatNumber(cfTotal);
            document.getElementById('grand-total').textContent = totalHuman;
        }

        // å¤©æ°”APIç±»
        class WeatherAPI {
            constructor() {
                this.baseUrl = 'https://api.open-meteo.com/v1/forecast';
            }

            async getWeather(province, city, days = 1, hourly = false) {
                try {
                    const response = await fetch(`${this.baseUrl}?latitude=23.02&longitude=113.12&current=temperature_2m,weather_code&daily=weather_code,temperature_2m_max,temperature_2m_min&timezone=Asia%2FShanghai`);

                    if (!response.ok) {
                        throw new Error('å¤©æ°”æ•°æ®è·å–å¤±è´¥');
                    }

                    const data = await response.json();
                    return this.formatWeatherData(data);
                } catch (error) {
                    console.error('è·å–å¤©æ°”æ•°æ®å¤±è´¥:', error);
                    return this.getFallbackWeatherData();
                }
            }

            formatWeatherData(data) {
                const current = data.current;
                const daily = data.daily;

                return {
                    temperature: Math.round(current.temperature_2m),
                    weatherCode: current.weather_code,
                    description: this.getWeatherDescription(current.weather_code),
                    icon: this.getWeatherIcon(current.weather_code),
                    maxTemp: Math.round(daily.temperature_2m_max[0]),
                    minTemp: Math.round(daily.temperature_2m_min[0])
                };
            }

            getWeatherDescription(code) {
                const descriptions = {
                    0: 'æ™´æœ—',
                    1: 'æ™´é—´å¤šäº‘',
                    2: 'å¤šäº‘',
                    3: 'é˜´å¤©',
                    45: 'é›¾',
                    48: 'é›¾',
                    51: 'å°é›¨',
                    53: 'ä¸­é›¨',
                    55: 'å¤§é›¨',
                    61: 'å°é›¨',
                    63: 'ä¸­é›¨',
                    65: 'å¤§é›¨',
                    80: 'é˜µé›¨',
                    81: 'é˜µé›¨',
                    82: 'å¼ºé˜µé›¨',
                    95: 'é›·æš´',
                    96: 'é›·æš´',
                    99: 'å¼ºé›·æš´'
                };
                return descriptions[code] || 'æœªçŸ¥';
            }

            getWeatherIcon(code) {
                const icons = {
                    0: 'â˜€ï¸',
                    1: 'â›…',
                    2: 'â˜ï¸',
                    3: 'â˜ï¸',
                    45: 'ğŸŒ«ï¸',
                    48: 'ğŸŒ«ï¸',
                    51: 'ğŸŒ§ï¸',
                    53: 'ğŸŒ§ï¸',
                    55: 'ğŸŒ§ï¸',
                    61: 'ğŸŒ§ï¸',
                    63: 'ğŸŒ§ï¸',
                    65: 'ğŸŒ§ï¸',
                    80: 'ğŸŒ¦ï¸',
                    81: 'ğŸŒ¦ï¸',
                    82: 'ğŸŒ§ï¸',
                    95: 'â›ˆï¸',
                    96: 'â›ˆï¸',
                    99: 'â›ˆï¸'
                };
                return icons[code] || 'â“';
            }

            getFallbackWeatherData() {
                return {
                    temperature: 25,
                    weatherCode: 0,
                    description: 'æ™´æœ—',
                    icon: 'â˜€ï¸',
                    maxTemp: 28,
                    minTemp: 22
                };
            }
        }

        // å¸¦ç¼“å­˜çš„å¤©æ°”APIç±»
        class CachedWeatherAPI extends WeatherAPI {
            constructor(cacheTtl = 600000) {
                super();
                this.cacheTtl = cacheTtl;
                this._cache = {};
                this._cacheTimestamp = {};
            }

            async getWeatherCached(province, city, days = 1, hourly = false) {
                const cacheKey = `${province}_${city}_${days}_${hourly}`;
                const currentTime = Date.now();

                if (cacheKey in this._cache &&
                    currentTime - (this._cacheTimestamp[cacheKey] || 0) < this.cacheTtl) {
                    return this._cache[cacheKey];
                }

                try {
                    const weatherData = await this.getWeather(province, city, days, hourly);
                    this._cache[cacheKey] = weatherData;
                    this._cacheTimestamp[cacheKey] = currentTime;
                    return weatherData;
                } catch (error) {
                    if (cacheKey in this._cache) {
                        console.warn('ä½¿ç”¨è¿‡æœŸçš„ç¼“å­˜æ•°æ®');
                        return this._cache[cacheKey];
                    }
                    throw error;
                }
            }
        }

        // æ—¥æœŸæ—¶é—´æ›´æ–°åŠŸèƒ½
        function updateDateTime() {
            const now = new Date();

            const dateOptions = { year: 'numeric', month: 'long', day: 'numeric' };
            const weekOptions = { weekday: 'long' };
            document.getElementById('current-date').textContent = now.toLocaleDateString('zh-CN', dateOptions);
            document.getElementById('current-week').textContent = now.toLocaleDateString('zh-CN', weekOptions);

            const timeOptions = { hour: '2-digit', minute: '2-digit', second: '2-digit', hour12: false };
            document.getElementById('current-time').textContent = now.toLocaleTimeString('zh-CN', timeOptions);
            document.getElementById('current-period').textContent = now.getHours() < 12 ? 'ä¸Šåˆ' : 'ä¸‹åˆ';
        }

        // çœŸå®å¤©æ°”æ•°æ®æ›´æ–°
        async function updateRealWeather() {
            const weatherAPI = new CachedWeatherAPI();

            try {
                const weatherData = await weatherAPI.getWeatherCached('å¹¿ä¸œ', 'ä½›å±±');

                document.getElementById('weather-temp').textContent = `${weatherData.temperature}Â°C`;
                document.getElementById('weather-desc').textContent = weatherData.description;
                document.querySelector('.weather-icon').textContent = weatherData.icon;

                const weatherSubtitle = document.getElementById('weather-desc');
                weatherSubtitle.innerHTML = `${weatherData.description}<br>${weatherData.minTemp}Â°C - ${weatherData.maxTemp}Â°C`;

            } catch (error) {
                console.error('å¤©æ°”æ•°æ®æ›´æ–°å¤±è´¥:', error);
                updateFallbackWeather();
            }
        }

        // å¤‡ç”¨å¤©æ°”æ•°æ®
        function updateFallbackWeather() {
            const weatherData = {
                temp: Math.floor(Math.random() * 10) + 20,
                desc: ['æ™´æœ—', 'å¤šäº‘', 'å°é›¨', 'é˜´å¤©'][Math.floor(Math.random() * 4)],
                icon: ['â˜€ï¸', 'â›…', 'ğŸŒ§ï¸', 'â˜ï¸'][Math.floor(Math.random() * 4)]
            };

            document.getElementById('weather-temp').textContent = `${weatherData.temp}Â°C`;
            document.getElementById('weather-desc').textContent = weatherData.desc;
            document.querySelector('.weather-icon').textContent = weatherData.icon;
        }

        // åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            updateDateTime();
            updateRealWeather();
            updateStats();

            setInterval(updateDateTime, 1000);
            setInterval(updateRealWeather, 600000);
            setInterval(updateStats, 600000);
        });
    </script>
</body>
</html>